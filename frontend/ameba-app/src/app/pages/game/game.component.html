<div class="game-container">
    <mat-card class="game-card">
        <mat-card-header>
            <mat-card-title>
                <mat-icon>videogame_asset</mat-icon>
                Game Arena
                @if (isLoading()) {
                <mat-spinner diameter="20"></mat-spinner>
                }
            </mat-card-title>
            <mat-card-subtitle>
                @if (gameConfig()) {
                {{gameConfig()!.play_desk.rows}}×{{gameConfig()!.play_desk.columns}} simulation environment
                } @else {
                Ameba simulation environment
                }
            </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content class="game-content">
            @if (isLoading()) {
            <div class="loading-state">
                <mat-spinner></mat-spinner>
                <p>Loading game configuration...</p>
            </div>
            } @else if (gameConfig()) {
            <!-- Game Statistics -->
            <div class="game-stats">
                <div class="stat-item">
                    <mat-icon>energy_savings_leaf</mat-icon>
                    <span>Energy per Food: {{gameConfig()!.play_desk.energy_per_food}}</span>
                </div>
                <div class="stat-item">
                    <mat-icon>battery_full</mat-icon>
                    <span>Total Energy: {{gameConfig()!.play_desk.total_energy}}</span>
                </div>
                <div class="stat-item">
                    <mat-icon>visibility</mat-icon>
                    <span>Ameba Vision:
                        {{gameConfig()!.ameba.visible_rows}}×{{gameConfig()!.ameba.visible_columns}}</span>
                </div>
            </div>

            <!-- Game Grid -->
            <div class="game-grid-container">
                <table class="game-table">
                    @for (row of getGameRows(); track $index) {
                    <tr class="game-row">
                        @for (cell of row; track cell.row + '-' + cell.col) {
                        <td class="game-cell" [ngClass]="getCellClass(cell)" [title]="getCellTitle(cell)"
                            [style.--move-x]="getCellMoveX(cell)" [style.--move-y]="getCellMoveY(cell)"
                            [attr.data-energy-gain]="getCellEnergyGain(cell)">
                            @switch (cell.type) {
                            @case ('ameba') {
                            <mat-icon class="cell-icon ameba-icon">pest_control</mat-icon>
                            }
                            @case ('food') {
                            <mat-icon class="cell-icon food-icon">local_dining</mat-icon>
                            }
                            @default {
                            <span class="empty-cell"></span>
                            }
                            }
                        </td>
                        }
                    </tr>
                    }
                </table>
            </div>

            <!-- Game Info -->
            <div class="game-info">
                <div class="info-row">
                    <span><strong>Amebas:</strong> {{getAmebaCount()}}</span>
                    <span><strong>Food:</strong> {{getFoodCount()}}</span>
                    <span><strong>Empty:</strong> {{getEmptyCount()}}</span>
                </div>
                <div class="info-row">
                    <span><strong>Iterations:</strong> {{movementStats().iterations}}</span>
                    @if (movementStats().lastMoveTime) {
                    <span><strong>Last Move:</strong> {{movementStats().lastMoveTime | date:'medium'}}</span>
                    }
                </div>
            </div>

            <!-- Movement Controls -->
            @if (gameConfig() && isGameRunning()) {
            <div class="movement-controls">
                <mat-card class="controls-card">
                    <mat-card-title>
                        <mat-icon>control_camera</mat-icon>
                        Movement Controls
                    </mat-card-title>
                    <mat-card-content>
                        <!-- Single Step Controls -->
                        <div class="control-section">
                            <h4>Single Step</h4>
                            <button mat-raised-button color="accent" [disabled]="isMoving()" (click)="singleStep()">
                                @if (isMoving()) {
                                <mat-spinner diameter="16"></mat-spinner>
                                } @else {
                                <mat-icon>skip_next</mat-icon>
                                }
                                Single Step
                            </button>
                            <button mat-stroked-button color="primary" [disabled]="isMoving()" (click)="animatedStep()">
                                @if (isMoving()) {
                                <mat-spinner diameter="16"></mat-spinner>
                                } @else {
                                <mat-icon>auto_awesome</mat-icon>
                                }
                                Animated Step
                            </button>
                        </div>

                        <!-- Auto Movement Controls -->
                        <div class="control-section">
                            <h4>Automatic Movement</h4>
                            <div class="auto-controls">
                                @if (autoMove()) {
                                <button mat-raised-button color="warn" [disabled]="isMoving()"
                                    (click)="toggleAutoMove()">
                                    <mat-icon>pause</mat-icon>
                                    Stop Auto
                                </button>
                                } @else {
                                <button mat-raised-button color="primary" [disabled]="isMoving()"
                                    (click)="toggleAutoMove()">
                                    <mat-icon>play_arrow</mat-icon>
                                    Start Auto
                                </button>
                                }

                                <div class="speed-control">
                                    <label>Speed (ms): {{simulationSpeed()}}</label>
                                    <input type="range" min="100" max="5000" step="100" [value]="simulationSpeed()"
                                        (input)="onSpeedChange($event)">
                                </div>
                            </div>
                        </div>

                        <!-- Full Simulation -->
                        <div class="control-section">
                            <h4>Full Simulation</h4>
                            <button mat-raised-button color="primary" [disabled]="isMoving()"
                                (click)="runFullSimulation()">
                                @if (isMoving()) {
                                <mat-spinner diameter="16"></mat-spinner>
                                } @else {
                                <mat-icon>fast_forward</mat-icon>
                                }
                                Run 50 Steps
                            </button>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
            }
            } @else {
            <div class="error-state">
                <mat-icon>error</mat-icon>
                <p>Failed to load game configuration</p>
            </div>
            }
        </mat-card-content>

        <mat-card-actions class="game-actions">
            <button mat-raised-button color="primary" [disabled]="!gameConfig() || isGameRunning()"
                (click)="startGame()">
                <mat-icon>play_arrow</mat-icon>
                Start Game
            </button>

            <button mat-raised-button color="warn" [disabled]="!isGameRunning()" (click)="stopGame()">
                <mat-icon>stop</mat-icon>
                Stop Game
            </button>

            <button mat-button (click)="resetGame()" [disabled]="!gameConfig()">
                <mat-icon>refresh</mat-icon>
                Reset
            </button>

            <button mat-button (click)="loadConfiguration()">
                <mat-icon>settings</mat-icon>
                Reload Config
            </button>

            <button mat-stroked-button routerLink="/">
                <mat-icon>home</mat-icon>
                Back to Home
            </button>
        </mat-card-actions>
    </mat-card>
</div>